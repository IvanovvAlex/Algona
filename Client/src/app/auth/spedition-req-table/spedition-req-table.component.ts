import { Component, OnDestroy, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { Subscription } from 'rxjs';
import { ApiService } from 'src/app/core/core-services/api-service/api.service';
import { SpeditionFormDataWithId } from 'src/app/shared/typization/interfaces/speditionFormData';


@Component({
  selector: 'app-spedition-req-table',
  templateUrl: './spedition-req-table.component.html',
  styleUrl: './spedition-req-table.component.css'
})
export class SpeditionReqTableComponent implements OnInit, OnDestroy{

  showEmail: boolean;
  showPallets: boolean;
  showDate: boolean;

  speditionRequests!:SpeditionFormDataWithId[]
  sortedArray!:SpeditionFormDataWithId[]

  currentPage = 1;
  totalPages?: number;
  paginatedArray?: any[];
  
  subscription: Subscription = new Subscription();


  constructor(private apiService: ApiService, private router: Router) {
    this.showEmail = false;
    this.showPallets = false;
    this.showDate = false;
  }

  getData():void {
    this.subscription = this.apiService.getSpeditionRequests().subscribe({
      next: (data) => {
        console.log(data);
        
        const mappedDataOne = data.map((x) => {
          x.date = `${x.fromDate} to ${x.toDate}`
          return x
        })
        const mappedDataTwo = mappedDataOne.map((x) => {
          x.destination = `${x.fromAddress} to ${x.toAddress}`
          return x
        })
        this.speditionRequests = mappedDataTwo;
        this.sortedArray = this.speditionRequests.sort((a, b) => {
          const statusOrder: any = { 'Waiting for approval': 1, 'Approved': 2, 'Complete': 3 };
          return statusOrder[a.status] - statusOrder[b.status];
        })
    
        this.totalPages = Math.ceil(this.sortedArray.length / 5);
        this.paginatedArray = this.sortedArray.slice(0, 5);
      },
      error: (err) => {
        this.router.navigate(['/404']);
      },
    });


    
  }

  ngOnInit(): void {
    this.getData()
  }

  onPageChanged(page: number): void {
    this.currentPage = page;
    if (page === 1) {
      if (this.sortedArray) {
        this.paginatedArray = this.sortedArray?.slice(0, 5);
      }
    } else {
      let startIndex = 5 * (page - 1)
      let endIndex = startIndex + 5
      if (this.sortedArray) {
        this.paginatedArray = this.sortedArray?.slice(startIndex, endIndex);
      }
    }


  }

  acceptSpdRequest(id: string, status: string) {
    if (status !== 'Pending') {
      return
    }

    const payload = {
      id,
      status: 'Approved'
    }

    this.apiService.updateSpeditionRequest(payload).subscribe(
      {
        next: (response) => {
          if (response.status === 200) {
            this.getData()
          }
        },
        error: (error) => {
          this.router.navigate(['/404']);
        }
      }
    )
  }

  completeSpdRequest(id: string, status: string) {
    if (status !== 'Approved') {
      return
    }

    const payload = {
      id,
      status: 'Complete'
    }

    this.apiService.updateSpeditionRequest(payload).subscribe(
      {
        next: (response) => {
          if (response.status === 200) {
            this.getData()
          }
        },
        error: (error) => {
          this.router.navigate(['/404']);
        }
      }
    )
  }

  rejectSpdRequest(id: string) {
    const confirmed = confirm('are you sure')
    if (!confirmed) {
      return
    }

    const payload = {
      id,
      status: 'Rejected'
    }

    this.apiService.updateSpeditionRequest(payload).subscribe(
      {
        next: (response) => {
          if (response.status === 200) {
            this.getData()
          }
        },
        error: (error) => {
          this.router.navigate(['/404']);
        }
      }
    )

  }

  ngOnDestroy(): void {
    this.subscription.unsubscribe();
  }

}
